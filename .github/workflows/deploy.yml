name: Deploy to BunnyCDN

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v2

            -   name: Set up Bun
                uses: oven-sh/setup-bun@v2

            -   name: Install dependencies
                run: bun install

            -   name: Install Playwright Browsers
                run: bunx playwright install --with-deps
            -   name: Run Playwright tests
                run: bunx playwright test

            -   name: Build project
                run: bun -b run build

            -   name: Deploy to BunnyCDN
                if: github.event_name == 'push' && github.ref == 'refs/heads/main'
                uses: ayeressian/bunnycdn-storage-deploy@v2.2.5
                with:
                    source: "dist"
                    destination: "/"
                    storageZoneName: "${{ secrets.STORAGE_NAME }}"
                    storagePassword: "${{ secrets.STORAGE_PASSWORD }}"
                    accessKey: "${{ secrets.STORAGE_KEY }}"
                    pullZoneId: "${{ secrets.ZONE_ID }}"
                    upload: "true"
                    remove: "true"
                    purgePullZone: "true"
